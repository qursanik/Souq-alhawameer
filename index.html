<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙˆÙ‚ Ø§Ù„Ù‡ÙˆØ§Ù…ÙŠØ± - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #1a4540;
            --primary-light: #236b61;
            --secondary: #d4af37;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #0d2624;
            --bg-secondary: #1a4540;
            --bg-card: #1f524d;
            --text-primary: #e8f1ed;
            --text-secondary: #a8c5b8;
            --border: #2d5650;
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f5f7f6;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #0a0f0d;
            --text-secondary: #5a6b62;
            --border: #d4dcd8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }

        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.6s ease-out; }

        /* Card & UI Elements */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 50px rgba(0,0,0,0.3); }

        .btn {
            padding: 1rem 2rem; border: none; border-radius: 12px;
            font-family: 'Cairo', sans-serif; font-size: 1rem; font-weight: 700;
            cursor: pointer; transition: all 0.3s ease; display: inline-block; text-align: center;
        }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; }
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #c0392b); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success), #27ae60); color: white; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.85rem; }

        /* Tabs */
        .tabs { display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .tab {
            padding: 1rem 1.5rem; background: none; border: none; color: var(--text-secondary);
            cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s ease;
        }
        .tab.active { color: var(--secondary); border-bottom-color: var(--secondary); font-weight: bold; }

        /* Stock Cards */
        .stock-card {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }

        /* Chat Styles */
        .chat-container { max-height: 500px; overflow-y: auto; padding: 1rem; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 1rem; }
        .chat-message { margin-bottom: 1rem; padding: 1rem; border-radius: 12px; max-width: 70%; }
        .chat-message.own { background: var(--primary); color: white; margin-left: auto; }
        .chat-message.other { background: var(--bg-card); margin-right: auto; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { text-align: right; padding: 1rem; border-bottom: 1px solid var(--border); }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; }

        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: var(--text-secondary); }
        .form-group input { width: 100%; padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; color: white; }

        .alert { padding: 1rem; border-radius: 12px; margin-bottom: 1rem; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; min-width: 300px; text-align: center; }
        .alert-success { background: #2ecc71; color: white; }
        .alert-error { background: #e74c3c; color: white; }
    </style>
</head>
<body data-theme="dark">
    <div id="app"></div>
    <div id="modals"></div>
    <script>
        
    const firebaseConfig = {
      apiKey: "AIzaSyC_Tb2a3FklDJhd_zWg_sE5kAaz7XG8mHM",
      authDomain: "souq-alhawameer.firebaseapp.com",
      projectId: "souq-alhawameer",
      storageBucket: "souq-alhawameer.firebasestorage.app",
      messagingSenderId: "7274083119",
      appId: "1:7274083119:web:800b10fb25272d7348e7da"
    };

    // ØªÙ‡ÙŠØ¦Ø© Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    console.log('ğŸ”¥ ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase Firestore Ø¨Ù†Ø¬Ø§Ø­!');

    // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ (Global State)
    let appState = {
        currentScreen: 'login',
        currentUser: null,
        theme: 'dark',
        showNotifications: false,
        selectedStock: null,
        activeTab: 'portfolio',
        activeAdminTab: 'settings',
        forgotPasswordPhone: null,
        recoveredUsername: null
    };

    // Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Data Structure)
    let appData = {
        users: [],
        stocks: [],
        portfolios: [],
        transactions: [],
        messages: [],
        activityLog: [],
        notifications: [],
        weeklyStats: {
            lastReset: null
        },
        settings: {
            tradingEnabled: false,
            chatEnabled: true
        }
    };

    // Ø¯Ø§Ù„Ø© ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± (SHA-256) Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø®ØµÙˆØµÙŠØ© Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹
    async function hashPassword(password) {
        const msgBuffer = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Ø§Ù„Ø£ÙˆØ³Ù…Ø© ÙˆØ§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª (Achievements)
    const achievements = [
        { id: 'first_trade', name: 'Ø£ÙˆÙ„ ØµÙÙ‚Ø©', icon: 'ğŸ¯', desc: 'Ø£ÙƒÙ…Ù„ Ø£ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡' },
        { id: 'first_profit', name: 'Ø£ÙˆÙ„ Ø±Ø¨Ø­', icon: 'ğŸ’°', desc: 'Ø­Ù‚Ù‚ Ø£ÙˆÙ„ Ø±Ø¨Ø­ Ù…Ù† Ø¨ÙŠØ¹ Ø³Ù‡Ù…' },
        { id: 'diversified', name: 'Ù…Ø­ÙØ¸Ø© Ù…ØªÙ†ÙˆØ¹Ø©', icon: 'ğŸ“Š', desc: 'Ø§Ù…ØªÙ„Ùƒ 3 Ø£Ø³Ù‡Ù… Ù…Ø®ØªÙ„ÙØ©' },
        { id: 'big_profit', name: 'Ø±Ø¨Ø­ ÙƒØ¨ÙŠØ±', icon: 'ğŸš€', desc: 'Ø­Ù‚Ù‚ Ø±Ø¨Ø­ 50% Ø£Ùˆ Ø£ÙƒØ«Ø±' },
        { id: 'active_trader', name: 'Ù…ØªØ¯Ø§ÙˆÙ„ Ù†Ø´Ø·', icon: 'âš¡', desc: 'Ù†ÙØ° 10 ØµÙÙ‚Ø§Øª' },
        { id: 'top_three', name: 'ÙÙŠ Ø§Ù„Ù‚Ù…Ø©', icon: 'ğŸ†', desc: 'ÙˆØµÙ„ Ù„Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰' }
    ];

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© (Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ) ---
    function setupRealtimeListeners() {
        console.log('ğŸ”„ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ù„Ø­Ø¸ÙŠ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª...');
        
        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ Ø§Ù„Ø£Ø³Ù‡Ù…ØŒ ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø³Ø±Ø¹Ø©
        db.collection('appData').doc('main')
            .onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    appData.stocks = data.stocks || [];
                    appData.settings = data.settings || appData.settings;
                    appData.messages = data.messages || [];
                    appData.activityLog = data.activityLog || [];
                    appData.notifications = data.notifications || [];
                    appData.weeklyStats = data.weeklyStats || appData.weeklyStats;
                    
                    render(); // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
                } else {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    db.collection('appData').doc('main').set(appData);
                }
            });

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸ ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ù†ÙØµÙ„Ø© Ù„Ù„Ø£Ù…Ø§Ù†
        db.collection('users').onSnapshot(snapshot => {
            appData.users = snapshot.docs.map(doc => doc.data());
            render();
        });

        db.collection('portfolios').onSnapshot(snapshot => {
            appData.portfolios = snapshot.docs.map(doc => doc.data());
            render();
        });
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ (Update Firestore) ---
    async function saveData() {
        try {
            await db.collection('appData').doc('main').update({
                stocks: appData.stocks,
                settings: appData.settings,
                messages: appData.messages,
                activityLog: appData.activityLog,
                notifications: appData.notifications,
                weeklyStats: appData.weeklyStats
            });
            console.log('âœ… ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ø¹ Firestore');
        } catch (e) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ:', e);
        }
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ ---
    async function init() {
        console.log('ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
        
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            try {
                const userData = JSON.parse(savedUser);
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
                const userDoc = await db.collection('users').doc(userData.username).get();
                if (userDoc.exists) {
                    appState.currentUser = userDoc.data();
                    appState.currentScreen = 'dashboard';
                }
            } catch (e) { console.error('ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©'); }
        }
        
        setupRealtimeListeners();
        render();
    }

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth Functions) ---
    async function handleLogin(e) {
        e.preventDefault();
        const username = e.target.username.value.trim();
        const password = e.target.password.value;

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©
        const user = appData.users.find(u => u.username === username);
        
        if (!user) {
            showAlert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ', 'error');
            return;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø¯Ø¹Ù… ÙƒÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙˆØ§Ù„ØªØ´ÙÙŠØ±)
        const passwordHash = await hashPassword(password);
        const isPasswordCorrect = (user.password && user.password === password) || 
                                 (user.passwordHash && user.passwordHash === passwordHash);
        
        if (!isPasswordCorrect) {
            showAlert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ', 'error');
            return;
        }

        if (user.suspended) {
            showAlert('ØªÙ… ØªØ¹Ù„ÙŠÙ‚ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â›”', 'error');
            return;
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­
        appState.currentUser = user;
        localStorage.setItem('currentUser', JSON.stringify({
            username: user.username,
            role: user.role
        }));
        
        appState.currentScreen = 'dashboard';
        addActivityLog('ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„', `${username} Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…`);
        render();
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ (Trading Logic) ---
    async function executeTrade(type, quantity) {
        if (!appData.settings.tradingEnabled && appState.currentUser.role !== 'admin') {
            showAlert('Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â›”', 'error');
            return;
        }

        const stock = appState.selectedStock;
        // ØªØ­Ø¯ÙŠØ« Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const user = appData.users.find(u => u.username === appState.currentUser.username);
        let portfolio = appData.portfolios.find(p => p.username === user.username);
        
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…Ø­ÙØ¸Ø©ØŒ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø©
        if (!portfolio) {
            portfolio = { username: user.username, holdings: [] };
            appData.portfolios.push(portfolio);
        }

        const cost = stock.price * quantity;

        if (type === 'buy') {
            if (user.balance < cost) {
                showAlert('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âŒ', 'error');
                return;
            }
            
            // Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯
            user.balance -= cost;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ÙØ¸Ø©
            const holding = portfolio.holdings.find(h => h.symbol === stock.symbol);
            if (holding) {
                const totalCost = (holding.avgPrice * holding.quantity) + cost;
                holding.quantity += quantity;
                holding.avgPrice = totalCost / holding.quantity;
            } else {
                portfolio.holdings.push({
                    symbol: stock.symbol,
                    quantity: quantity,
                    avgPrice: stock.price
                });
            }

            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
            appData.transactions.unshift({
                id: Date.now(),
                username: user.username,
                symbol: stock.symbol,
                name: stock.name,
                type: 'buy',
                quantity,
                price: stock.price,
                total: cost,
                timestamp: new Date().toISOString()
            });
            
            showAlert(`âœ… ØªÙ… Ø´Ø±Ø§Ø¡ ${quantity} Ù…Ù† ${stock.name}`, 'success');

        } else if (type === 'sell') {
            const holding = portfolio.holdings.find(h => h.symbol === stock.symbol);
            if (!holding || holding.quantity < quantity) {
                showAlert('Ù„Ø§ ØªÙ…Ù„Ùƒ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒØ§ÙÙŠØ© Ù„Ù„Ø¨ÙŠØ¹ âŒ', 'error');
                return;
            }

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯
            user.balance += cost;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©
            const profit = (stock.price - holding.avgPrice) * quantity;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ÙØ¸Ø©
            holding.quantity -= quantity;
            if (holding.quantity === 0) {
                portfolio.holdings = portfolio.holdings.filter(h => h.symbol !== stock.symbol);
            }

            appData.transactions.unshift({
                id: Date.now(),
                username: user.username,
                symbol: stock.symbol,
                name: stock.name,
                type: 'sell',
                quantity,
                price: stock.price,
                total: cost,
                profit,
                timestamp: new Date().toISOString()
            });

            showAlert(`âœ… ØªÙ… Ø¨ÙŠØ¹ ${quantity} Ù…Ù† ${stock.name}`, 'success');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©
        checkAchievements(user.username);
        
        // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹
        await saveData();
        
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        appState.currentUser = user;
        appState.selectedStock = null;
        render();
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Chat System) ---
    async function sendMessage(text) {
        if (!text.trim()) return;
        
        if (appState.currentUser.role !== 'admin' && !appData.settings.chatEnabled) {
            showAlert('Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØºÙ„Ù‚Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø´Ø±Ù ğŸ”’', 'error');
            return;
        }

        const message = {
            id: Date.now(),
            from: appState.currentUser.username,
            text,
            timestamp: new Date().toISOString(),
            isAdmin: appState.currentUser.role === 'admin'
        };
        
        appData.messages.push(message);
        // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 200 Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø· Ù„ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (appData.messages.length > 200) appData.messages.shift();
        
        await saveData();
    }

    async function deleteMessage(id) {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) {
            appData.messages = appData.messages.filter(m => m.id !== id);
            await saveData();
        }
    }

    async function toggleChat() {
        appData.settings.chatEnabled = !appData.settings.chatEnabled;
        showAlert(`Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ${appData.settings.chatEnabled ? 'Ù…ÙØªÙˆØ­Ø© ğŸ”“' : 'Ù…ØºÙ„Ù‚Ø© ğŸ”’'}`, 'success');
        await saveData();
    }

    // --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø´Ø±Ù (Admin Tools) ---
    async function toggleTrading() {
        appData.settings.tradingEnabled = !appData.settings.tradingEnabled;
        addActivityLog('ØªØºÙŠÙŠØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', `Ø§Ù„ØªØ¯Ø§ÙˆÙ„ ${appData.settings.tradingEnabled ? 'Ù…ÙØªÙˆØ­' : 'Ù…ØºÙ„Ù‚'}`);
        await saveData();
    }

    async function addBalance() {
        const amount = parseFloat(document.getElementById('balanceInput').value);
        if (!amount || amount <= 0) return showAlert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­', 'error');
        
        const user = appData.users.find(u => u.username === balanceModalState.username);
        user.balance += amount;
        
        addActivityLog('Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯', `${user.username} +${amount.toFixed(2)}`);
        showAlert(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${amount} Ø±.Ø³ Ù„Ù„Ø·Ø§Ù„Ø¨ ${user.username}`, 'success');
        
        await saveData();
        closeBalanceModal();
    }

    async function subtractBalance() {
        const amount = parseFloat(document.getElementById('balanceInput').value);
        if (!amount || amount <= 0) return showAlert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­', 'error');
        
        const user = appData.users.find(u => u.username === balanceModalState.username);
        user.balance -= amount;
        
        addActivityLog('Ø®ØµÙ… Ø±ØµÙŠØ¯', `${user.username} -${amount.toFixed(2)}`);
        showAlert(`âœ… ØªÙ… Ø®ØµÙ… ${amount} Ø±.Ø³ Ù…Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ ${user.username}`, 'success');
        
        await saveData();
        closeBalanceModal();
    }

    // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© (Helper Functions) ---
    function checkAchievements(username) {
        const user = appData.users.find(u => u.username === username);
        const userTxs = appData.transactions.filter(t => t.username === username);
        if (!user) return;

        // Ù…Ø«Ø§Ù„: Ø£ÙˆÙ„ ØµÙÙ‚Ø©
        if (userTxs.length >= 1 && !user.achievements.includes('first_trade')) {
            user.achievements.push('first_trade');
            showAlert('ğŸ† Ø¥Ù†Ø¬Ø§Ø² Ø¬Ø¯ÙŠØ¯: Ø£ÙˆÙ„ ØµÙÙ‚Ø©!', 'success');
        }
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø´Ø±ÙˆØ· Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ù‡Ù†Ø§
    }

    function addActivityLog(action, details) {
        appData.activityLog.unshift({
            id: Date.now(),
            user: appState.currentUser?.username || 'system',
            action,
            details,
            timestamp: new Date().toISOString()
        });
        // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 100 Ø³Ø¬Ù„
        appData.activityLog = appData.activityLog.slice(0, 100);
    }

    function getPortfolioValue(username) {
        const portfolio = appData.portfolios.find(p => p.username === username);
        if (!portfolio) return 0;
        return portfolio.holdings.reduce((total, h) => {
            const stock = appData.stocks.find(s => s.symbol === h.symbol);
            return total + (stock ? stock.price * h.quantity : 0);
        }, 0);
    }

    function generateHistory(price) {
        const history = [];
        let p = price;
        for (let i = 0; i < 30; i++) {
            p = p * (1 + (Math.random() * 0.1 - 0.05)); // ØªØºÙŠÙŠØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¨Ø³ÙŠØ·
            history.push(p);
        }
        return history;
    }

    function showAlert(text, type = 'success') {
        const alertEl = document.createElement('div');
        alertEl.className = `alert alert-${type} animate-slide-up`;
        alertEl.textContent = text;
        document.body.appendChild(alertEl);
        setTimeout(() => alertEl.remove(), 3000);
    }

    // --- Ø¯ÙˆØ§Ù„ Ø±Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Render Functions) ---
    function render() {
        const app = document.getElementById('app');
        const user = appState.currentUser;

        // 1. Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹)
        if (!user) {
            app.innerHTML = `
                <div style="height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                    <div class="card animate-slide-up" style="width: 100%; max-width: 400px; text-align: center;">
                        <h1 style="color: var(--secondary); margin-bottom: 2rem;">Ø³ÙˆÙ‚ Ø§Ù„Ù‡ÙˆØ§Ù…ÙŠØ± ğŸ“Š</h1>
                        <form onsubmit="handleLogin(event)">
                            <div class="form-group">
                                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                                <input type="text" name="username" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§...">
                            </div>
                            <div class="form-group">
                                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                <input type="password" name="password" required placeholder="******">
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³ÙˆÙ‚ ğŸš€</button>
                        </form>
                    </div>
                </div>
            `;
            return;
        }

        // 2. ÙˆØ§Ø¬Ù‡Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Dashboard)
        const portfolioValue = getPortfolioValue(user.username);
        const totalWealth = user.balance + portfolioValue;

        app.innerHTML = `
            <div class="container animate-slide-up">
                <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div>
                        <h2 style="color: var(--secondary);">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user.username} ğŸ‘‹</h2>
                        <p style="color: var(--text-secondary);">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©: ${totalWealth.toFixed(2)} Ø±.Ø³</p>
                    </div>
                    <div>
                        ${user.role === 'admin' ? '<span class="btn btn-danger btn-small">Ù…Ø´Ø±Ù Ø§Ù„Ù†Ø¸Ø§Ù… ğŸ›¡ï¸</span>' : ''}
                        <button onclick="location.reload()" class="btn btn-secondary btn-small">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸšª</button>
                    </div>
                </header>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="card" style="text-align: center;">
                        <h3>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ</h3>
                        <p style="font-size: 1.5rem; color: var(--success);">${user.balance.toFixed(2)}</p>
                    </div>
                    <div class="card" style="text-align: center;">
                        <h3>ğŸ“ˆ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø³Ù‡Ù…</h3>
                        <p style="font-size: 1.5rem; color: var(--warning);">${portfolioValue.toFixed(2)}</p>
                    </div>
                    <div class="card" style="text-align: center;">
                        <h3>ğŸ† ØµØ§ÙÙŠ Ø§Ù„Ø«Ø±ÙˆØ©</h3>
                        <p style="font-size: 1.5rem; color: var(--secondary);">${totalWealth.toFixed(2)}</p>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab ${appState.activeTab === 'market' ? 'active' : ''}" onclick="switchTab('market')">Ø³ÙˆÙ‚ Ø§Ù„Ø£Ø³Ù‡Ù… ğŸ¢</button>
                    <button class="tab ${appState.activeTab === 'portfolio' ? 'active' : ''}" onclick="switchTab('portfolio')">Ù…Ø­ÙØ¸ØªÙŠ ğŸ’¼</button>
                    <button class="tab ${appState.activeTab === 'chat' ? 'active' : ''}" onclick="switchTab('chat')">Ù…Ø¬Ù„Ø³ Ø§Ù„Ù‡ÙˆØ§Ù…ÙŠØ± ğŸ’¬</button>
                    ${user.role === 'admin' ? `<button class="tab ${appState.activeTab === 'admin' ? 'active' : ''}" onclick="switchTab('admin')">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… âš™ï¸</button>` : ''}
                </div>

                <div id="tab-content">
                    ${getTabContent()}
                </div>
            </div>
        `;
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø¨Ø¹Ø¯ Ø±Ø³Ù… Ø§Ù„Ø¹Ù†Ø§ØµØ±
        if (appState.activeTab === 'market' && appState.selectedStock) {
            initChart(appState.selectedStock);
        }
    }

    // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ (Router)
    function getTabContent() {
        switch(appState.activeTab) {
            case 'market': return renderMarket();
            case 'portfolio': return renderPortfolio();
            case 'chat': return renderChat();
            case 'admin': return renderAdminPanel();
            default: return renderMarket();
        }
    }

    // 1. Ø±Ø³Ù… Ø³ÙˆÙ‚ Ø§Ù„Ø£Ø³Ù‡Ù…
    function renderMarket() {
        return `
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                <div>
                    ${appData.stocks.map(stock => `
                        <div class="stock-card" onclick="selectStock('${stock.symbol}')" style="${appState.selectedStock?.symbol === stock.symbol ? 'border-color: var(--secondary); background: var(--bg-card);' : ''}">
                            <div>
                                <h3 style="color: var(--secondary);">${stock.symbol}</h3>
                                <p>${stock.name}</p>
                            </div>
                            <div style="text-align: left;">
                                <h3 style="color: ${stock.change >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                    ${stock.price.toFixed(2)}
                                </h3>
                                <small>${stock.change}%</small>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="card" style="position: sticky; top: 20px; height: fit-content;">
                    ${appState.selectedStock ? `
                        <h2 style="color: var(--secondary); margin-bottom: 1rem;">${appState.selectedStock.name} (${appState.selectedStock.symbol})</h2>
                        <canvas id="stockChart" width="400" height="200"></canvas>
                        
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button onclick="executeTrade('buy', 1)" class="btn btn-success" style="flex: 1;">Ø´Ø±Ø§Ø¡ (1)</button>
                            <button onclick="executeTrade('sell', 1)" class="btn btn-danger" style="flex: 1;">Ø¨ÙŠØ¹ (1)</button>
                        </div>
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                            <button onclick="promptTrade('buy')" class="btn btn-secondary" style="flex: 1;">Ø´Ø±Ø§Ø¡ ÙƒÙ…ÙŠØ©</button>
                            <button onclick="promptTrade('sell')" class="btn btn-secondary" style="flex: 1;">Ø¨ÙŠØ¹ ÙƒÙ…ÙŠØ©</button>
                        </div>
                    ` : '<p style="text-align: center; padding: 2rem;">Ø§Ø®ØªØ± Ø³Ù‡Ù…Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ğŸ‘ˆ</p>'}
                </div>
            </div>
        `;
    }

    // 2. Ø±Ø³Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©
    function renderPortfolio() {
        const user = appState.currentUser;
        const portfolio = appData.portfolios.find(p => p.username === user.username);
        
        if (!portfolio || !portfolio.holdings.length) {
            return `<div class="card" style="text-align: center; padding: 3rem;"><h3>Ù…Ø­ÙØ¸ØªÙƒ ÙØ§Ø±ØºØ©! Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø¢Ù† ğŸ“‰</h3></div>`;
        }

        return `
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø´Ø±ÙƒØ©</th>
                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th>Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                            <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                            <th>Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${portfolio.holdings.map(h => {
                            const stock = appData.stocks.find(s => s.symbol === h.symbol) || { price: 0 };
                            const profit = (stock.price - h.avgPrice) * h.quantity;
                            return `
                                <tr>
                                    <td>${h.symbol}</td>
                                    <td>${h.quantity}</td>
                                    <td>${h.avgPrice.toFixed(2)}</td>
                                    <td>${stock.price.toFixed(2)}</td>
                                    <td style="color: ${profit >= 0 ? 'var(--success)' : 'var(--danger)'}; direction: ltr;">
                                        ${profit.toFixed(2)}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªÙ†Ù‚Ù„
    function switchTab(tab) {
        appState.activeTab = tab;
        render();
    }

    function selectStock(symbol) {
        appState.selectedStock = appData.stocks.find(s => s.symbol === symbol);
        render();
    }

    function promptTrade(type) {
        const qty = prompt(`Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ${type === 'buy' ? 'Ø´Ø±Ø§Ø¤Ù‡Ø§' : 'Ø¨ÙŠØ¹Ù‡Ø§'}:`);
        if (qty && !isNaN(qty)) executeTrade(type, parseInt(qty));
    }

    // 3. Ø±Ø³Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ù…Ø¬Ù„Ø³ Ø§Ù„Ù‡ÙˆØ§Ù…ÙŠØ±)
    function renderChat() {
        return `
            <div class="card" style="height: 600px; display: flex; flex-direction: column;">
                <h3 style="margin-bottom: 1rem; color: var(--secondary);">ğŸ’¬ Ù…Ø¬Ù„Ø³ Ø§Ù„Ù‡ÙˆØ§Ù…ÙŠØ±</h3>
                
                <div class="chat-container" style="flex: 1; overflow-y: auto;">
                    ${appData.messages.map(msg => `
                        <div class="chat-message ${msg.from === appState.currentUser.username ? 'own' : 'other'}" 
                             style="${msg.isAdmin ? 'border: 1px solid var(--secondary);' : ''}">
                            <small style="color: var(--text-secondary);">${msg.from} ${msg.isAdmin ? 'ğŸ‘‘' : ''} - ${new Date(msg.timestamp).toLocaleTimeString('ar-SA')}</small>
                            <p>${msg.text}</p>
                            ${appState.currentUser.role === 'admin' ? 
                                `<button onclick="deleteMessage(${msg.id})" style="color: var(--danger); background: none; border: none; cursor: pointer; float: left;">Ø­Ø°Ù</button>` 
                            : ''}
                        </div>
                    `).join('')}
                </div>

                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." 
                           onkeypress="if(event.key === 'Enter') sendMessage(this.value); this.value = ''">
                    <button onclick="const input = document.getElementById('chatInput'); sendMessage(input.value); input.value = '';" 
                            class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„ âœˆï¸</button>
                </div>
            </div>
        `;
    }

    // 4. Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù (Admin Panel)
    function renderAdminPanel() {
        if (appState.currentUser.role !== 'admin') return '<p>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© â›”</p>';

        return `
            <div class="card animate-slide-up">
                <h2 style="color: var(--danger); margin-bottom: 1rem;">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    
                    <div class="card" style="background: var(--bg-primary);">
                        <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚</h3>
                        <p>Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹: <strong>${appData.settings.tradingEnabled ? 'Ù…ÙØªÙˆØ­ âœ…' : 'Ù…ØºÙ„Ù‚ â›”'}</strong></p>
                        <button onclick="toggleTrading()" class="btn ${appData.settings.tradingEnabled ? 'btn-danger' : 'btn-success'}">
                            ${appData.settings.tradingEnabled ? 'Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³ÙˆÙ‚ ğŸ”’' : 'ÙØªØ­ Ø§Ù„Ø³ÙˆÙ‚ ğŸ”“'}
                        </button>
                        <hr style="margin: 1rem 0; border-color: var(--border);">
                        <button onclick="toggleChat()" class="btn btn-secondary">
                            ${appData.settings.chatEnabled ? 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ”‡' : 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ”Š'}
                        </button>
                    </div>

                    <div class="card" style="background: var(--bg-primary);">
                        <h3>Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                        <input type="text" id="newStockSymbol" placeholder="Ø§Ù„Ø±Ù…Ø² (Ù…Ø«Ø§Ù„: ARAMCO)" style="margin-bottom: 0.5rem; width: 100%; padding: 0.5rem;">
                        <input type="text" id="newStockName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©" style="margin-bottom: 0.5rem; width: 100%; padding: 0.5rem;">
                        <input type="number" id="newStockPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø§ÙƒØªØªØ§Ø¨" style="margin-bottom: 0.5rem; width: 100%; padding: 0.5rem;">
                        <button onclick="addNewStockFromAdmin()" class="btn btn-success" style="width: 100%;">Ø·Ø±Ø­ Ø§Ù„Ø³Ù‡Ù… ğŸ“ˆ</button>
                    </div>

                    <div class="card" style="background: var(--bg-primary);">
                        <h3>Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø©)</h3>
                        <input type="text" id="targetUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" style="margin-bottom: 0.5rem; width: 100%; padding: 0.5rem;">
                        <input type="number" id="amountCalc" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="margin-bottom: 0.5rem; width: 100%; padding: 0.5rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="modifyBalance('add')" class="btn btn-success" style="flex: 1;">Ø¥ÙŠØ¯Ø§Ø¹ â•</button>
                            <button onclick="modifyBalance('subtract')" class="btn btn-danger" style="flex: 1;">Ø®ØµÙ… â–</button>
                        </div>
                    </div>
                </div>

                <h3 style="margin-top: 2rem;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø¯Ø±Ø¬Ø©</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    ${appData.stocks.map((stock, index) => `
                        <div style="border: 1px solid var(--border); padding: 1rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <b>${stock.name}</b>
                            <button onclick="removeStock(${index})" style="background: var(--danger); color: white; border: none; padding: 0.2rem 0.5rem; cursor: pointer; border-radius: 4px;">Ø­Ø°Ù ğŸ—‘ï¸</button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù‡Ù… Ù…Ù† Ø§Ù„Ù„ÙˆØ­Ø©
    function addNewStockFromAdmin() {
        const symbol = document.getElementById('newStockSymbol').value;
        const name = document.getElementById('newStockName').value;
        const price = document.getElementById('newStockPrice').value;
        if(symbol && name && price) {
            addNewStock(symbol, name, price);
            // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('newStockSymbol').value = '';
            document.getElementById('newStockName').value = '';
            document.getElementById('newStockPrice').value = '';
        } else {
            showAlert('Ø£Ø¯Ø®Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        }
    }

    // Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯
    async function modifyBalance(action) {
        const username = document.getElementById('targetUser').value;
        const amount = parseFloat(document.getElementById('amountCalc').value);
        
        const user = appData.users.find(u => u.username === username);
        if (!user || isNaN(amount)) {
            showAlert('Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù…Ø¨Ù„Øº Ø®Ø§Ø·Ø¦', 'error');
            return;
        }

        if (action === 'add') user.balance += amount;
        else user.balance -= amount;

        await saveData();
        showAlert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ ${username} Ø¨Ù†Ø¬Ø§Ø­ âœ…`, 'success');
    }

    // --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (Chart.js) ---
    let stockChartInstance = null;
    function initChart(stock) {
        const ctx = document.getElementById('stockChart')?.getContext('2d');
        if (!ctx) return;

        if (stockChartInstance) stockChartInstance.destroy();

        stockChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: stock.history.length}, (_, i) => i + 1),
                datasets: [{
                    label: `Ø³Ø¹Ø± ${stock.name}`,
                    data: stock.history,
                    borderColor: '#d4af37',
                    backgroundColor: 'rgba(212, 175, 55, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: '#2d5650' }, ticks: { color: '#a8c5b8' } },
                    x: { display: false }
                }
            }
        });
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    init();

    </script>
</body>
</html>
